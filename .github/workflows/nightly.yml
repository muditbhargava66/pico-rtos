name: Nightly Build

on:
  schedule:
    # Run every night at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  ARM_TOOLCHAIN_VERSION: "13.3.rel1"

jobs:
  # Ubuntu nightly build
  nightly-ubuntu:
    name: Nightly Build (Ubuntu)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi cmake ninja-build
    
    - name: Setup Pico SDK
      run: git submodule update --init --recursive
    
    - name: Build Debug
      run: |
        python3 scripts/build.py configure --build-type Debug --enable-examples
        python3 scripts/build.py build
        mv build build-debug
      continue-on-error: true
    
    - name: Build Release
      run: |
        python3 scripts/build.py configure --build-type Release --enable-examples
        python3 scripts/build.py build
      continue-on-error: true
    
    - name: Run build system tests
      run: python3 tests/build_system_test.py
      continue-on-error: true
    
    - name: Generate build report
      run: |
        echo "## Nightly Build Report for Ubuntu" > build-report.md
        echo "- OS: ubuntu-latest" >> build-report.md
        echo "- Build Status: ${{ job.status == 'success' && '✅ Success' || '❌ Failed' }}" >> build-report.md
        echo "- Timestamp: $(date)" >> build-report.md
        echo "- Examples Built: $(find build -name "*.uf2" 2>/dev/null | wc -l)" >> build-report.md
        
        if [ -f build/libpico_rtos.a ]; then
          SIZE=$(stat -c%s build/libpico_rtos.a 2>/dev/null || stat -f%z build/libpico_rtos.a)
          echo "- Library Size: $SIZE bytes" >> build-report.md
        fi
    
    - name: Archive build artifacts
      run: |
        mkdir -p artifacts
        cp build-report.md artifacts/
        [ -f build/libpico_rtos.a ] && cp build/libpico_rtos.a artifacts/
        find build -name "*.uf2" -exec cp {} artifacts/ \;
        tar -czf artifacts.tar.gz artifacts/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nightly-build-ubuntu-${{ github.run_number }}
        path: artifacts.tar.gz
        retention-days: 30
    
    - name: Cleanup workspace
      run: rm -rf build build-debug artifacts
      if: always()

  # macOS nightly build with official ARM toolchain
  nightly-macos:
    name: Nightly Build (macOS)
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install build tools
      run: brew install cmake ninja
    
    - name: Download ARM toolchain
      run: |
        # Download ARM GNU Toolchain from official ARM website
        TOOLCHAIN_URL="https://developer.arm.com/-/media/Files/downloads/gnu/${{ env.ARM_TOOLCHAIN_VERSION }}/binrel/arm-gnu-toolchain-${{ env.ARM_TOOLCHAIN_VERSION }}-darwin-arm64-arm-none-eabi.tar.xz"
        
        echo "Downloading ARM toolchain from: $TOOLCHAIN_URL"
        curl -L -o arm-toolchain.tar.xz "$TOOLCHAIN_URL"
        
        # Extract to /opt
        sudo mkdir -p /opt/arm-gnu-toolchain
        sudo tar -xf arm-toolchain.tar.xz -C /opt/arm-gnu-toolchain --strip-components=1
        
        # Add to PATH
        echo "/opt/arm-gnu-toolchain/bin" >> $GITHUB_PATH
        
        # Verify installation
        /opt/arm-gnu-toolchain/bin/arm-none-eabi-gcc --version
    
    - name: Setup Pico SDK
      run: git submodule update --init --recursive
    
    - name: Build Debug
      run: |
        python3 scripts/build.py configure --build-type Debug --enable-examples
        python3 scripts/build.py build
        mv build build-debug
      continue-on-error: true
    
    - name: Build Release
      run: |
        python3 scripts/build.py configure --build-type Release --enable-examples
        python3 scripts/build.py build
      continue-on-error: true
    
    - name: Run build system tests
      run: python3 tests/build_system_test.py
      continue-on-error: true
    
    - name: Generate build report
      run: |
        echo "## Nightly Build Report for macOS" > build-report.md
        echo "- OS: macos-latest" >> build-report.md
        echo "- Build Status: ${{ job.status == 'success' && '✅ Success' || '❌ Failed' }}" >> build-report.md
        echo "- Timestamp: $(date)" >> build-report.md
        echo "- Examples Built: $(find build -name "*.uf2" 2>/dev/null | wc -l)" >> build-report.md
        
        if [ -f build/libpico_rtos.a ]; then
          SIZE=$(stat -f%z build/libpico_rtos.a)
          echo "- Library Size: $SIZE bytes" >> build-report.md
        fi
    
    - name: Archive build artifacts
      run: |
        mkdir -p artifacts
        cp build-report.md artifacts/
        [ -f build/libpico_rtos.a ] && cp build/libpico_rtos.a artifacts/
        find build -name "*.uf2" -exec cp {} artifacts/ \;
        tar -czf artifacts.tar.gz artifacts/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nightly-build-macos-${{ github.run_number }}
        path: artifacts.tar.gz
        retention-days: 30
    
    - name: Cleanup workspace
      run: rm -rf build build-debug artifacts
      if: always()

  # Generate summary from all builds
  nightly-summary:
    name: Generate Nightly Summary
    runs-on: ubuntu-latest
    needs: [nightly-ubuntu, nightly-macos]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate summary report
      run: |
        echo "# Pico-RTOS Nightly Build Summary" > nightly-summary.md
        echo "Date: $(date)" >> nightly-summary.md
        echo "Run: ${{ github.run_number }}" >> nightly-summary.md
        echo "" >> nightly-summary.md
        
        echo "## Build Results" >> nightly-summary.md
        for artifact in nightly-build-*/artifacts.tar.gz; do
          if [ -f "$artifact" ]; then
            tar -xzf "$artifact"
            if [ -f artifacts/build-report.md ]; then
              cat artifacts/build-report.md >> nightly-summary.md
              echo "" >> nightly-summary.md
            fi
          fi
        done
        
        echo "## Summary" >> nightly-summary.md
        echo "- Total builds: $(find . -name 'build-report.md' | wc -l)" >> nightly-summary.md
    
    - name: Upload nightly summary
      uses: actions/upload-artifact@v4
      with:
        name: nightly-summary-${{ github.run_number }}
        path: nightly-summary.md
        retention-days: 90