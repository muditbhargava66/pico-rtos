name: Nightly Build

on:
  schedule:
    # Run every night at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # Simplified nightly build matrix
  nightly-build:
    name: Nightly Build (${{ matrix.config.name }})
    runs-on: ${{ matrix.config.os }}
    
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Ubuntu Latest"
            os: ubuntu-latest
            install: sudo apt-get update && sudo apt-get install -y gcc-arm-none-eabi cmake
          - name: "macOS Latest"
            os: macos-latest
            install: brew install arm-none-eabi-gcc cmake
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: ${{ matrix.config.install }}
      shell: bash
    
    - name: Setup Pico SDK
      run: git submodule update --init --recursive
      shell: bash
    
    - name: Build Debug
      run: |
        python3 scripts/build.py configure --build-type Debug --enable-examples
        python3 scripts/build.py build
        mv build build-debug
      shell: bash
    
    - name: Build Release
      run: |
        python3 scripts/build.py configure --build-type Release --enable-examples
        python3 scripts/build.py build
      shell: bash
    
    - name: Run build system tests
      run: python3 tests/build_system_test.py
      shell: bash
    
    - name: Generate build report
      run: |
        echo "## Nightly Build Report for ${{ matrix.config.name }}" > build-report.md
        echo "- OS: ${{ matrix.config.os }}" >> build-report.md
        echo "- Build Status: âœ… Success" >> build-report.md
        echo "- Timestamp: $(date)" >> build-report.md
        echo "- Examples Built: $(find build -name "*.uf2" | wc -l)" >> build-report.md
        
        if [ -f build/libpico_rtos.a ]; then
          SIZE=$(stat -c%s build/libpico_rtos.a 2>/dev/null || stat -f%z build/libpico_rtos.a)
          echo "- Library Size: $SIZE bytes" >> build-report.md
        fi
      shell: bash
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: nightly-build-${{ matrix.config.name }}-${{ github.run_number }}
        path: |
          build-report.md
          build/libpico_rtos.a
          build/*.uf2
        retention-days: 30

  # Generate nightly summary
  nightly-summary:
    name: Generate Nightly Summary
    runs-on: ubuntu-latest
    needs: [nightly-build]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Generate summary report
      run: |
        echo "# Pico-RTOS Nightly Build Summary" > nightly-summary.md
        echo "Date: $(date)" >> nightly-summary.md
        echo "Run: ${{ github.run_number }}" >> nightly-summary.md
        echo "" >> nightly-summary.md
        
        echo "## Build Results" >> nightly-summary.md
        for report in nightly-build-*/build-report.md; do
          if [ -f "$report" ]; then
            cat "$report" >> nightly-summary.md
            echo "" >> nightly-summary.md
          fi
        done
        
        echo "## Summary" >> nightly-summary.md
        echo "- Total builds: ${{ strategy.job-total }}" >> nightly-summary.md
        echo "- Successful builds: $(find . -name "build-report.md" | wc -l)" >> nightly-summary.md
    
    - name: Upload nightly summary
      uses: actions/upload-artifact@v3
      with:
        name: nightly-summary-${{ github.run_number }}
        path: nightly-summary.md
        retention-days: 90